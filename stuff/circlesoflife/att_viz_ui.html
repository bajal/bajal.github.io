<!DOCTYPE html>
<!-- This code is for demonstration purposes only.  You should not hotlink to Github, Rawgit, or files from the Cytoscape.js documentation in your production apps. -->
<html>
    <head>
        <!--link href="style.css" rel="stylesheet" /-->
        <meta charset=utf-8 />
        <meta name="viewport" content="user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">
        <title>Animated BFS</title>
        <script src="./cytoscape.min.js "></script>
		<script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
		<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.5.0/cytoscape-dagre.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="att_viz.js"></script>
    </head>
    <style>
        body {
            font: 14px helvetica neue, helvetica, arial, sans-serif;
        }
        #cy {
            height: 100%;
            width: 100%;
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>
    <body>
        <div id="cy"></div>
        <!-- Load application code at the end to ensure DOM is loaded -->
        <script>
            $(document).ready(function () {

                var cypherQuery = "WITH $bans as bansVar WITH bansVar[0..10] as bans " +
                    "MATCH path =((root)-[*2..4]->(b:BAN)) " +
                    "WHERE b.id IN bans AND (root:DSLAM OR root:OLT) with nodes(path) as nodes, relationships(path) as rels " +
                    " with collect(nodes) as nodeLists, collect(rels) as relLists WITH reduce(result = [], x in nodeLists | apoc.coll.union( result, x) ) as nodes, reduce(result = [], x in relLists | apoc.coll.union( result, x) ) as rels WITH nodes, rels, reduce (s = '#dummy', item in [x IN nodes WHERE x.id IN $affectedequips | id(x)] | s + ',#' + item) as affectedEquipIds " +
                    " RETURN { nodes: [ x in nodes | x{ data : { id:id(x), showText: CASE WHEN x.nodeType IS NULL THEN '' ELSE x.nodeType END + ': ' + x.id } , classes: CASE WHEN x.nodeType IS NULL THEN '' ELSE x.nodeType END  + CASE WHEN x.id IN $affectedequips THEN ' BROKEN' ELSE '' END}], edges: [ x in rels | x { data: { id: id(x), source: id(startNode(x)), target: id(endNode(x))}} ] } as result, reduce( result = '#dummy',  dslam in [x in nodes where (x.nodeType = 'DSLAM' or x.nodeType = 'OLT') | id(x)] | result + ',#' +dslam) as roots, affectedEquipIds"

                var params = {
                    "affectedequips": ['SNJSCA12OL1010175041'],
                    "bans": [
                        "253474959",
                        "147568759",
                        "152139311",
                        "100416049",
                        "250733223",
                        "256469409",
                        "159029869",
                        "253084848",
                        "159288278",
                        "250992685"
                    ]
                };

                AttViz.startCytoscape('cy');
                /*
                AttViz.doPostSearch(cypherQuery, params, function (data) {
                    if (!data || data.length == 0 || data.rows.length == 0) {
                        alert('no data returned');
                        return;
                    }
                    var row = data.rows[0];
                    var cytoscapeData = row['result'];
                    var roots = row['roots'];
                    var affectedEquipIds = row['affectedEquipIds'];

                    AttViz.showData2(cytoscapeData);
                    AttViz.doLayout(roots);
                    setTimeout(function () {
                        //AttViz.highlightBrokenNodes(affectedEquipIds);
                        AttViz.highlightBrokenNodes2(affectedEquipIds);
                    }, 500);

                }*/
                AttViz.doPostSearch2(cypherQuery, params, "neo4j", "admin", function (data) {

                    var row = data.results[0].data[0].row;
                    var cytoscapeData = row[0];
                    var roots = row[1];
                    var affectedEquipIds = row[2];

                    AttViz.showData(cytoscapeData);
                    AttViz.doLayout(roots);
                    setTimeout(function () {
                        //AttViz.highlightBrokenNodes(affectedEquipIds);
                        AttViz.highlightBrokenNodes2(affectedEquipIds);
                    }, 500);

                });
            });
        </script>
    </body>
</html>
